import { Injectable, Inject } from "@angular/core";
import { throwError } from "rxjs";
import { catchError, map } from "rxjs/operators";
import { Angular2PrestaImageSize } from "./angular2-presta.image.size";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export class Angular2PrestaService {
    constructor(config, http) {
        this.config = config;
        this.http = http;
        this.TAG = "Angular2Presta: ";
    }
    /*
     * [requestConstructor : analyze Query object, construct and return request url]
     * @param  {PrestaQuery}  q [Query object]
     * @return {[string]}   [request url]
     */
    requestConstructor(q) {
        // check if params are set, if not set default values
        if (!q.resource) {
            q.resource = "products";
        }
        // Check if display is set if not return results with all properties
        !q.display
            ? (q.display = `&display=full`)
            : (q.display = `&display=[${q.display}]`);
        // Generate filter query from Query.filter object if it is defined
        let filterQuery = "";
        if (q.filter) {
            for (const property in q.filter) {
                if (property) {
                    filterQuery += `&filter[${property}]=[${q.filter[property]}]`;
                }
            }
        }
        !q.sort ? (q.sort = "") : (q.sort = `&sort=[${q.sort}]`);
        !q.limit ? (q.limit = "") : (q.limit = `&limit=${q.limit}`);
        if (!q.search) {
            return (this.config.shopUrl +
                q.resource +
                "?ws_key=" +
                this.config.apiKey +
                "&output_format=JSON" +
                q.display +
                filterQuery +
                q.sort +
                q.limit);
        }
        else {
            return (this.config.shopUrl +
                "search" +
                "?ws_key=" +
                this.config.apiKey +
                "&output_format=JSON&language=1" +
                q.display +
                filterQuery +
                "&query=" +
                q.search);
        }
    }
    fetchForm(resource) {
        return this.http.get(`${this.config.shopUrl}${resource}?schema=blank&ws_key=${this.config.apiKey}`, { responseType: "text" });
    }
    /*
     * [get results from presta shop web service]
     * @param  {PrestaQuery}           q [query object]
     * @return {Observable<any>}   [results object array]
     */
    get(q) {
        return this.http.get(this.requestConstructor(q)).pipe(map((resp) => resp[q.resource]), catchError(this.handleError));
    }
    delete(resource, resourceId) {
        return this.http.delete(`${this.config.shopUrl}${resource}/${resourceId}?ws_key=${this.config.apiKey}`);
    }
    /*
     * [search]
     * @param  {PrestaQuery}           q [query object with search term provided]
     * @return {Observable<Response>}   [return results object array]
     */
    search(q) {
        return this.http.get(this.requestConstructor(q)).pipe(map((resp) => resp[q.resource]), catchError(this.handleError));
    }
    /*
     * [getImage used by PrestaImage component to get images from Presta Shop Web Service]
     * @param  {string} resource   [general, products, categories, manufacturers, suppliers, stores]
     * @param  {number} resourceID [ID of resurce to get images for]
     * @param  {number} imageID    [ID of image to get]
     * @param  {string} imageSize  [cart, small, medium, large, thickbox, home, category]
     * @return {string}            [url]
     */
    getImage(resource, resourceID, imageID, imageSize) {
        // check if imageApiKey is defined if not use default apiKey (not recomended for security reasons)
        let key = "";
        !this.config.imageApiKey
            ? (key = this.config.apiKey)
            : (key = this.config.imageApiKey);
        // check if image size is defined if not get large images by default
        if (!imageSize) {
            imageSize = Angular2PrestaImageSize.large;
        }
        if (resource === "products") {
            return (this.config.shopUrl +
                "images/" +
                resource +
                "/" +
                resourceID +
                "/" +
                imageID +
                "/" +
                Angular2PrestaImageSize[imageSize] +
                "?ws_key=" +
                key);
        }
        else {
            return (this.config.shopUrl +
                "images/" +
                resource +
                "/" +
                resourceID +
                "?ws_key=" +
                key);
        }
    }
    handleError(error) {
        if (error.error instanceof ErrorEvent) {
            // A client-side or network error occurred. Handle it accordingly.
            console.error(this.TAG + "An error occurred:", error.error.message);
        }
        else {
            // The backend returned an unsuccessful response code.
            // The response body may contain clues as to what went wrong,
            console.error(`${this.TAG} Backend returned code ${error.status}, ` +
                `body was: ${error.error}`);
        }
        // return an observable with a user-facing error message
        return throwError(`${this.TAG} Something bad happened; please try again later.`);
    }
}
Angular2PrestaService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.0", ngImport: i0, type: Angular2PrestaService, deps: [{ token: "prestaConfiguration" }, { token: i1.HttpClient }], target: i0.ɵɵFactoryTarget.Injectable });
Angular2PrestaService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.1.0", ngImport: i0, type: Angular2PrestaService, providedIn: "root" });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.0", ngImport: i0, type: Angular2PrestaService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: "root",
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: ["prestaConfiguration"]
                }] }, { type: i1.HttpClient }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhcjItcHJlc3RhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyMi1wcmVzdGEvc3JjL2xpYi9hbmd1bGFyMi1wcmVzdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVuRCxPQUFPLEVBQWMsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLakQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sOEJBQThCLENBQUM7OztBQUt2RSxNQUFNLE9BQU8scUJBQXFCO0lBR2hDLFlBQ3lDLE1BQW1DLEVBQ2xFLElBQWdCO1FBRGUsV0FBTSxHQUFOLE1BQU0sQ0FBNkI7UUFDbEUsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUoxQixRQUFHLEdBQUcsa0JBQWtCLENBQUM7SUFLdEIsQ0FBQztJQUVKOzs7O09BSUc7SUFDSCxrQkFBa0IsQ0FBQyxDQUFzQjtRQUN2QyxxREFBcUQ7UUFDckQsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUU7WUFDZixDQUFDLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQztTQUN6QjtRQUVELG9FQUFvRTtRQUNwRSxDQUFDLENBQUMsQ0FBQyxPQUFPO1lBQ1IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxlQUFlLENBQUM7WUFDL0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBRTVDLGtFQUFrRTtRQUNsRSxJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFFckIsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFO1lBQ1osS0FBSyxNQUFNLFFBQVEsSUFBSSxD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WCxHQUFHLElBQUksQ0FBQyxHQUFHLDBCQUEwQixLQUFLLENBQUMsTUFBTSxJQUFJO2dCQUNuRCxhQUFhLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FDN0IsQ0FBQztTQUNIO1FBQ0Qsd0RBQXdEO1FBQ3hELE9BQU8sVUFBVSxDQUNmLEdBQUcsSUFBSSxDQUFDLEdBQUcsa0RBQWtELENBQzlELENBQUM7SUFDSixDQUFDOztrSEExS1UscUJBQXFCLGtCQUl0QixxQkFBcUI7c0hBSnBCLHFCQUFxQixjQUZwQixNQUFNOzJGQUVQLHFCQUFxQjtrQkFIakMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQUtJLE1BQU07MkJBQUMscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuXG4vLyBJbXBvcnQgcHJlc3RhIGNvbmZpZ3VyYXRpb25cbmltcG9ydCB7IEFuZ3VsYXIyUHJlc3RhQ29uZmlndXJhdGlvbiB9IGZyb20gXCIuL2FuZ3VsYXIyLXByZXN0YS5jb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBBbmd1bGFyMlByZXN0YVF1ZXJ5IH0gZnJvbSBcIi4vYW5ndWxhcjItcHJlc3RhLnF1ZXJ5XCI7XG5pbXBvcnQgeyBBbmd1bGFyMlByZXN0YUltYWdlU2l6ZSB9IGZyb20gXCIuL2FuZ3VsYXIyLXByZXN0YS5pbWFnZS5zaXplXCI7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogXCJyb290XCIsXG59KVxuZXhwb3J0IGNsYXNzIEFuZ3VsYXIyUHJlc3RhU2VydmljZSB7XG4gIFRBRyA9IFwiQW5ndWxhcjJQcmVzdGE6IFwiO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoXCJwcmVzdGFDb25maWd1cmF0aW9uXCIpIHByaXZhdGUgY29uZmlnOiBBbmd1bGFyMlByZXN0YUNvbmZpZ3VyYXRpb24sXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50XG4gICkge31cblxuICAvKlxuICAgKiBbcmVxdWVzdENvbnN0cnVjdG9yIDogYW5hbHl6ZSBRdWVyeSBvYmplY3QsIGNvbnN0cnVjdCBhbmQgcmV0dXJuIHJlcXVlc3QgdXJsXVxuICAgKiBAcGFyYW0gIHtQcmVzdGFRdWVyeX0gIHEgW1F1ZXJ5IG9iamVjdF1cbiAgICogQHJldHVybiB7W3N0cmluZ119ICAgW3JlcXVlc3QgdXJsXVxuICAgKi9cbiAgcmVxdWVzdENvbnN0cnVjdG9yKHE6IEFuZ3VsYXIyUHJlc3RhUXVlcnkpOiBzdHJpbmcge1xuICAgIC8vIGNoZWNrIGlmIHBhcmFtcyBhcmUgc2V0LCBpZiBub3Qgc2V0IGRlZmF1bHQgdmFsdWVzXG4gICAgaWYgKCFxLnJlc291cmNlKSB7XG4gICAgICBxLnJlc291cmNlID0gXCJwcm9kdWN0c1wiO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGRpc3BsYXkgaXMgc2V0IGlmIG5vdCByZXR1cm4gcmVzdWx0cyB3aXRoIGFsbCBwcm9wZXJ0aWVzXG4gICAgIXEuZGlzcGxheVxuICAgICAgPyAocS5kaXNwbGF5ID0gYCZkaXNwbGF5PWZ1bGxgKVxuICAgICAgOiAocS5kaXNwbGF5ID0gYCZkaXNwbGF5PVske3EuZGlzcGxheX1dYCk7XG5cbiAgICAvLyBHZW5lcmF0ZSBmaWx0ZXIgcXVlcnkgZnJvbSBRdWVyeS5maWx0ZXIgb2JqZWN0IGlmIGl0IGlzIGRlZmluZWRcbiAgICBsZXQgZmlsdGVyUXVlcnkgPSBcIlwiO1xuXG4gICAgaWYgKHEuZmlsdGVyKSB7XG4gICAgICBmb3IgKGNvbnN0IHByb3BlcnR5IGluIHEuZmlsdGVyKSB7XG4gICAgICAgIGlmIChwcm9wZXJ0eSkge1xuICAgICAgICAgIGZpbHRlclF1ZXJ5ICs9IGAmZmlsdGVyWyR7cHJvcGVydHl9XT1bJHtxLmZpbHRlcltwcm9wZXJ0eV19XWA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAhcS5zb3J0ID8gKHEuc29ydCA9IFwiXCIpIDogKHEuc29ydCA9IGAmc29ydD1bJHtxLnNvcnR9XWApO1xuICAgICFxLmxpbWl0ID8gKHEubGltaXQgPSBcIlwiKSA6IChxLmxpbWl0ID0gYCZsaW1pdD0ke3EubGltaXR9YCk7XG5cbiAgICBpZiAoIXEuc2VhcmNoKSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICB0aGlzLmNvbmZpZy5zaG9wVXJsICtcbiAgICAgICAgcS5yZXNvdXJjZSArXG4gICAgICAgIFwiP3dzX2tleT1cIiArXG4gICAgICAgIHRoaXMuY29uZmlnLmFwaUtleSArXG4gICAgICAgIFwiJm91dHB1dF9mb3JtYXQ9SlNPTlwiICtcbiAgICAgICAgcS5kaXNwbGF5ICtcbiAgICAgICAgZmlsdGVyUXVlcnkgK1xuICAgICAgICBxLnNvcnQgK1xuICAgICAgICBxLmxpbWl0XG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICB0aGlzLmNvbmZpZy5zaG9wVXJsICtcbiAgICAgICAgXCJzZWFyY2hcIiArXG4gICAgICAgIFwiP3dzX2tleT1cIiArXG4gICAgICAgIHRoaXMuY29uZmlnLmFwaUtleSArXG4gICAgICAgIFwiJm91dHB1dF9mb3JtYXQ9SlNPTiZsYW5ndWFnZT0xXCIgK1xuICAgICAgICBxLmRpc3BsYXkgK1xuICAgICAgICBmaWx0ZXJRdWVyeSArXG4gICAgICAgIFwiJnF1ZXJ5PVwiICtcbiAgICAgICAgcS5zZWFyY2hcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgZmV0Y2hGb3JtKHJlc291cmNlOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KFxuICAgICAgYCR7dGhpcy5jb25maWcuc2hvcFVybH0ke3Jlc291cmNlfT9zY2hlbWE9Ymxhbmsmd3Nfa2V5PSR7dGhpcy5jb25maWcuYXBpS2V5fWAsXG4gICAgICB7IHJlc3BvbnNlVHlwZTogXCJ0ZXh0XCIgfVxuICAgICk7XG4gIH1cblxuICAvKlxuICAgKiBbZ2V0IHJlc3VsdHMgZnJvbSBwcmVzdGEgc2hvcCB3ZWIgc2VydmljZV1cbiAgICogQHBhcmFtICB7UHJlc3RhUXVlcnl9ICAgICAgICAgICBxIFtxdWVyeSBvYmplY3RdXG4gICAqIEByZXR1cm4ge09ic2VydmFibGU8YW55Pn0gICBbcmVzdWx0cyBvYmplY3QgYXJyYXldXG4gICAqL1xuICBnZXQocTogQW5ndWxhcjJQcmVzdGFRdWVyeSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy5yZXF1ZXN0Q29uc3RydWN0b3IocSkpLnBpcGUoXG4gICAgICBtYXAoKHJlc3ApID0+IHJlc3BbcS5yZXNvdXJjZV0pLFxuICAgICAgY2F0Y2hFcnJvcih0aGlzLmhhbmRsZUVycm9yKVxuICAgICk7XG4gIH1cblxuICBkZWxldGUocmVzb3VyY2U6IHN0cmluZywgcmVzb3VyY2VJZDogbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmRlbGV0ZShcbiAgICAgIGAke3RoaXMuY29uZmlnLnNob3BVcmx9JHtyZXNvdXJjZX0vJHtyZXNvdXJjZUlkfT93c19rZXk9JHt0aGlzLmNvbmZpZy5hcGlLZXl9YFxuICAgICk7XG4gIH1cblxuICAvKlxuICAgKiBbc2VhcmNoXVxuICAgKiBAcGFyYW0gIHtQcmVzdGFRdWVyeX0gICAgICAgICAgIHEgW3F1ZXJ5IG9iamVjdCB3aXRoIHNlYXJjaCB0ZXJtIHByb3ZpZGVkXVxuICAgKiBAcmV0dXJuIHtPYnNlcnZhYmxlPFJlc3BvbnNlPn0gICBbcmV0dXJuIHJlc3VsdHMgb2JqZWN0IGFycmF5XVxuICAgKi9cbiAgc2VhcmNoKHE6IEFuZ3VsYXIyUHJlc3RhUXVlcnkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHRoaXMucmVxdWVzdENvbnN0cnVjdG9yKHEpKS5waXBlKFxuICAgICAgbWFwKChyZXNwKSA9PiByZXNwW3EucmVzb3VyY2VdKSxcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5oYW5kbGVFcnJvcilcbiAgICApO1xuICB9XG5cbiAgLypcbiAgICogW2dldEltYWdlIHVzZWQgYnkgUHJlc3RhSW1hZ2UgY29tcG9uZW50IHRvIGdldCBpbWFnZXMgZnJvbSBQcmVzdGEgU2hvcCBXZWIgU2VydmljZV1cbiAgICogQHBhcmFtICB7c3RyaW5nfSByZXNvdXJjZSAgIFtnZW5lcmFsLCBwcm9kdWN0cywgY2F0ZWdvcmllcywgbWFudWZhY3R1cmVycywgc3VwcGxpZXJzLCBzdG9yZXNdXG4gICAqIEBwYXJhbSAge251bWJlcn0gcmVzb3VyY2VJRCBbSUQgb2YgcmVzdXJjZSB0byBnZXQgaW1hZ2VzIGZvcl1cbiAgICogQHBhcmFtICB7bnVtYmVyfSBpbWFnZUlEICAgIFtJRCBvZiBpbWFnZSB0byBnZXRdXG4gICAqIEBwYXJhbSAge3N0cmluZ30gaW1hZ2VTaXplICBbY2FydCwgc21hbGwsIG1lZGl1bSwgbGFyZ2UsIHRoaWNrYm94LCBob21lLCBjYXRlZ29yeV1cbiAgICogQHJldHVybiB7c3RyaW5nfSAgICAgICAgICAgIFt1cmxdXG4gICAqL1xuICBnZXRJbWFnZShcbiAgICByZXNvdXJjZTogc3RyaW5nLFxuICAgIHJlc291cmNlSUQ6IG51bWJlcixcbiAgICBpbWFnZUlEPzogbnVtYmVyLFxuICAgIGltYWdlU2l6ZT86IHN0cmluZ1xuICApOiBzdHJpbmcge1xuICAgIC8vIGNoZWNrIGlmIGltYWdlQXBpS2V5IGlzIGRlZmluZWQgaWYgbm90IHVzZSBkZWZhdWx0IGFwaUtleSAobm90IHJlY29tZW5kZWQgZm9yIHNlY3VyaXR5IHJlYXNvbnMpXG4gICAgbGV0IGtleSA9IFwiXCI7XG4gICAgIXRoaXMuY29uZmlnLmltYWdlQXBpS2V5XG4gICAgICA/IChrZXkgPSB0aGlzLmNvbmZpZy5hcGlLZXkpXG4gICAgICA6IChrZXkgPSB0aGlzLmNvbmZpZy5pbWFnZUFwaUtleSk7XG5cbiAgICAvLyBjaGVjayBpZiBpbWFnZSBzaXplIGlzIGRlZmluZWQgaWYgbm90IGdldCBsYXJnZSBpbWFnZXMgYnkgZGVmYXVsdFxuICAgIGlmICghaW1hZ2VTaXplKSB7XG4gICAgICBpbWFnZVNpemUgPSBBbmd1bGFyMlByZXN0YUltYWdlU2l6ZS5sYXJnZTtcbiAgICB9XG5cbiAgICBpZiAocmVzb3VyY2UgPT09IFwicHJvZHVjdHNcIikge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgdGhpcy5jb25maWcuc2hvcFVybCArXG4gICAgICAgIFwiaW1hZ2VzL1wiICtcbiAgICAgICAgcmVzb3VyY2UgK1xuICAgICAgICBcIi9cIiArXG4gICAgICAgIHJlc291cmNlSUQgK1xuICAgICAgICBcIi9cIiArXG4gICAgICAgIGltYWdlSUQgK1xuICAgICAgICBcIi9cIiArXG4gICAgICAgIEFuZ3VsYXIyUHJlc3RhSW1hZ2VTaXplW2ltYWdlU2l6ZV0gK1xuICAgICAgICBcIj93c19rZXk9XCIgK1xuICAgICAgICBrZXlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIHRoaXMuY29uZmlnLnNob3BVcmwgK1xuICAgICAgICBcImltYWdlcy9cIiArXG4gICAgICAgIHJlc291cmNlICtcbiAgICAgICAgXCIvXCIgK1xuICAgICAgICByZXNvdXJjZUlEICtcbiAgICAgICAgXCI/d3Nfa2V5PVwiICtcbiAgICAgICAga2V5XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSB7XG4gICAgaWYgKGVycm9yLmVycm9yIGluc3RhbmNlb2YgRXJyb3JFdmVudCkge1xuICAgICAgLy8gQSBjbGllbnQtc2lkZSBvciBuZXR3b3JrIGVycm9yIG9jY3VycmVkLiBIYW5kbGUgaXQgYWNjb3JkaW5nbHkuXG4gICAgICBjb25zb2xlLmVycm9yKHRoaXMuVEFHICsgXCJBbiBlcnJvciBvY2N1cnJlZDpcIiwgZXJyb3IuZXJyb3IubWVzc2FnZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRoZSBiYWNrZW5kIHJldHVybmVkIGFuIHVuc3VjY2Vzc2Z1bCByZXNwb25zZSBjb2RlLlxuICAgICAgLy8gVGhlIHJlc3BvbnNlIGJvZHkgbWF5IGNvbnRhaW4gY2x1ZXMgYXMgdG8gd2hhdCB3ZW50IHdyb25nLFxuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgYCR7dGhpcy5UQUd9IEJhY2tlbmQgcmV0dXJuZWQgY29kZSAke2Vycm9yLnN0YXR1c30sIGAgK1xuICAgICAgICAgIGBib2R5IHdhczogJHtlcnJvci5lcnJvcn1gXG4gICAgICApO1xuICAgIH1cbiAgICAvLyByZXR1cm4gYW4gb2JzZXJ2YWJsZSB3aXRoIGEgdXNlci1mYWNpbmcgZXJyb3IgbWVzc2FnZVxuICAgIHJldHVybiB0aHJvd0Vycm9yKFxuICAgICAgYCR7dGhpcy5UQUd9IFNvbWV0aGluZyBiYWQgaGFwcGVuZWQ7IHBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuYFxuICAgICk7XG4gIH1cbn1cbiJdfQ==